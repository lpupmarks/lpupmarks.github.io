<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ukulele Note Detector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        #noteDisplay {
            font-size: 2rem;
            margin-top: 20px;
        }

        #frequencyDisplay {
            font-size: 1.5rem;
            margin-top: 10px;
        }

        #consoleLog {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            height: 150px;
            overflow-y: scroll;
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Ukulele Note Detector</h1>
    <button id="startButton">Start Listening</button>
    <div id="noteDisplay">Note: -</div>
    <div id="frequencyDisplay">Frequency: - Hz</div>
    <div id="consoleLog">Console Log:</div>

    <!-- Include Tone.js and Pitchy libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.35/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pitchy@2.3.0/dist/index.min.js"></script>

    <script>
        const noteDisplay = document.getElementById('noteDisplay');
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        const consoleLog = document.getElementById('consoleLog');
        const startButton = document.getElementById('startButton');

        let audioContext;
        let analyserNode;
        let pitchEstimator;
        let bufferLength;
        let buffer;
        let threshold = 5; // Frequency tolerance threshold

        // Predefined ukulele notes and their frequencies
        const notes = {
            'C': 261.63,
            'G': 392.00
        };

        // Log messages to the page console
        function logMessage(message) {
            const logItem = document.createElement('div');
            logItem.textContent = message;
            consoleLog.appendChild(logItem);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        // Start listening to audio input
        async function startListening() {
            logMessage('Starting audio listening...');
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioContext.createMediaStreamSource(stream);
            analyserNode = audioContext.createAnalyser();
            analyserNode.fftSize = 2048;
            source.connect(analyserNode);

            // Initialize Pitchy
            pitchEstimator = Pitchy.getPitchEstimator(audioContext.sampleRate);
            bufferLength = analyserNode.fftSize;
            buffer = new Float32Array(bufferLength);

            detectPitch();
        }

        // Detect the pitch of the incoming audio
        function detectPitch() {
            analyserNode.getFloatTimeDomainData(buffer);
            const [frequency, clarity] = pitchEstimator(buffer);

            if (clarity > 0.98 && frequency) { // Adjust clarity threshold for better accuracy
                displayNoteAndFrequency(frequency);
            } else {
                noteDisplay.textContent = `Note: -`;
                frequencyDisplay.textContent = `Frequency: - Hz`;
            }

            requestAnimationFrame(detectPitch);
        }

        // Display the detected note and frequency
        function displayNoteAndFrequency(frequency) {
            let detectedNote = '-';
            for (const [note, noteFreq] of Object.entries(notes)) {
                if (Math.abs(frequency - noteFreq) < threshold) {
                    detectedNote = note;
                    break;
                }
            }

            noteDisplay.textContent = `Note: ${detectedNote}`;
            frequencyDisplay.textContent = `Frequency: ${frequency.toFixed(2)} Hz`;
            logMessage(`Detected Frequency: ${frequency.toFixed(2)} Hz, Note: ${detectedNote}`);

            if (detectedNote === 'C' || detectedNote === 'G') {
                alert('Good!');
            }
        }

        startButton.addEventListener('click', startListening);
    </script>
</body>
</html>
