<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ukulele Note Matcher</title>
    <style>
        #successDiv {
            display: none;
            padding: 20px;
            background-color: lightgreen;
            border: 2px solid green;
            margin-top: 20px;
        }

        #detectedNote, #detectedFrequency {
            font-size: 20px;
            margin-top: 20px;
            color: blue;
        }

        #logContainer {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Ukulele Note Matcher</h1>
    <button id="startDetection">Start Detection</button>
    <div id="detectedNote">Detected Note: None</div>
    <div id="detectedFrequency">Detected Frequency: None</div>
    <div id="successDiv">You played the correct notes!</div>
    <div id="logContainer"></div> <!-- Log display section -->

    <!-- Import pitchy library -->
    <script src="https://cdn.jsdelivr.net/npm/pitchy@3.1.1/dist/pitchy.min.js"></script>
    <script>
        // Variables to manage audio processing
        let audioContext;
        let analyserNode;
        let sourceNode;
        let pitchDetector;
        let buffer;

        // Example target notes to compare
        const targetNotes = ['C', 'E', 'G', 'A']; // Add 'A' if you want to detect all standard tuning notes

        // Start detection button event listener
        document.getElementById('startDetection').addEventListener('click', () => {
            logMessage('Starting detection...');
            startAudioProcessing();
        });

        async function startAudioProcessing() {
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = 2048;
                sourceNode = audioContext.createMediaStreamSource(stream);
                sourceNode.connect(analyserNode);

                // Initialize pitch detector with buffer size matching analyser
                pitchDetector = pitchy.PitchDetector.forFloat32Array(analyserNode.fftSize);

                // Buffer to hold the audio data
                buffer = new Float32Array(analyserNode.fftSize);

                logMessage('Microphone access granted, starting audio processing...');
                processAudio();
            } catch (error) {
                logMessage(`Error accessing microphone: ${error}`);
                console.error('Error accessing microphone:', error);
            }
        }

        function processAudio() {
            // Set an interval to continuously process the audio input
            const checkNotesInterval = setInterval(() => {
                // Capture the audio data into the buffer
                analyserNode.getFloatTimeDomainData(buffer);

                // Run pitch detection
                const [frequency, clarity] = pitchDetector.findPitch(buffer, audioContext.sampleRate);

                if (clarity > 0.8) { // Adjust this value for more sensitivity
                    const note = detectNoteFromFrequency(frequency);

                    // Display the detected note and frequency
                    if (note) {
                        document.getElementById('detectedNote').innerText = `Detected Note: ${note}`;
                    } else {
                        document.getElementById('detectedNote').innerText = 'Detected Note: None';
                    }

                    document.getElementById('detectedFrequency').innerText = `Detected Frequency: ${frequency.toFixed(2)} Hz`;

                    // Log the detected values
                    logMessage(`Detected Frequency: ${frequency.toFixed(2)} Hz, Note: ${note || 'None'}, Clarity: ${clarity.toFixed(2)}`);

                    // Check if the detected note is in the target notes
                    if (targetNotes.includes(note)) {
                        document.getElementById('successDiv').style.display = 'block';
                        clearInterval(checkNotesInterval);
                        logMessage('Correct notes played!');
                    }
                } else {
                    document.getElementById('detectedNote').innerText = 'Detected Note: None';
                    document.getElementById('detectedFrequency').innerText = 'Detected Frequency: None';
                    logMessage('No clear note detected.');
                }
            }, 200);
        }

        function detectNoteFromFrequency(frequency) {
            // Common ukulele tuning (G4, C4, E4, A4)
            if (frequency >= 246.94 && frequency <= 261.63) return 'C'; // C4
            if (frequency >= 329.63 && frequency <= 349.23) return 'E'; // E4
            if (frequency >= 392.00 && frequency <= 415.30) return 'G'; // G4
            if (frequency >= 440.00 && frequency <= 466.16) return 'A'; // A4
            // Expand the ranges based on detected frequencies and tuning
            return null;
        }

        // Function to append log messages to the log container
        function logMessage(message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.textContent = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to the latest message
        }
    </script>
</body>
</html>
