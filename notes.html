<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ukulele Note Matcher</title>
    <style>
        #successDiv {
            display: none;
            padding: 20px;
            background-color: lightgreen;
            border: 2px solid green;
            margin-top: 20px;
        }

        #detectedNote, #detectedFrequency {
            font-size: 20px;
            margin-top: 20px;
            color: blue;
        }

        #logContainer {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Ukulele Note Matcher</h1>
    <button id="startDetection">Start Detection</button>
    <div id="detectedNote">Detected Note: None</div>
    <div id="detectedFrequency">Detected Frequency: None</div>
    <div id="successDiv">You played the correct notes!</div>
    <div id="logContainer"></div> <!-- Log display section -->

    <!-- Import Essentia.js and its WASM backend -->
    <script src="https://cdn.jsdelivr.net/gh/MTG/essentia.js/dist/essentia.js-core.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/MTG/essentia.js/dist/essentia-wasm.module.js"></script>
    <script>
        let audioContext;
        let analyserNode;
        let sourceNode;
        let scriptProcessor;
        let essentia; // This will hold the initialized Essentia.js object

        const targetNotes = ['C', 'E', 'G', 'A']; // Example target notes

        document.getElementById('startDetection').addEventListener('click', async () => {
            logMessage('Starting detection...');
            await initializeEssentia();
            startAudioProcessing();
        });

        async function initializeEssentia() {
            try {
                // Initialize Essentia.js with its WASM backend
                essentia = await EssentiaWASM();
                logMessage('Essentia.js initialized successfully.');
            } catch (error) {
                logMessage(`Error initializing Essentia.js: ${error}`);
                console.error('Error initializing Essentia.js:', error);
            }
        }

        async function startAudioProcessing() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = 2048;
                sourceNode = audioContext.createMediaStreamSource(stream);
                sourceNode.connect(analyserNode);

                scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
                analyserNode.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                logMessage('Microphone access granted, starting audio processing...');
                processAudio();
            } catch (error) {
                logMessage(`Error accessing microphone: ${error}`);
                console.error('Error accessing microphone:', error);
            }
        }

        function processAudio() {
            scriptProcessor.onaudioprocess = (event) => {
                const buffer = event.inputBuffer.getChannelData(0);

                // Using Essentia's PitchYinProbabilistic algorithm to detect pitch
                const pitchDetectionResult = essentia.PitchYinProbabilistic(buffer, audioContext.sampleRate);
                const frequency = pitchDetectionResult.pitch;

                if (frequency && frequency > 0) {
                    const note = detectNoteFromFrequency(frequency);
                    document.getElementById('detectedNote').innerText = `Detected Note: ${note || 'None'}`;
                    document.getElementById('detectedFrequency').innerText = `Detected Frequency: ${frequency.toFixed(2)} Hz`;
                    logMessage(`Detected Frequency: ${frequency.toFixed(2)} Hz, Note: ${note || 'None'}`);

                    if (targetNotes.includes(note)) {
                        document.getElementById('successDiv').style.display = 'block';
                        logMessage('Correct notes played!');
                    }
                } else {
                    document.getElementById('detectedNote').innerText = 'Detected Note: None';
                    document.getElementById('detectedFrequency').innerText = 'Detected Frequency: None';
                    logMessage('No clear note detected.');
                }
            };
        }

        function detectNoteFromFrequency(frequency) {
            // Common ukulele tuning (G4, C4, E4, A4)
            if (frequency >= 246.94 && frequency <= 261.63) return 'C'; // C4
            if (frequency >= 329.63 && frequency <= 349.23) return 'E'; // E4
            if (frequency >= 392.00 && frequency <= 415.30) return 'G'; // G4
            if (frequency >= 440.00 && frequency <= 466.16) return 'A'; // A4
            return null;
        }

        function logMessage(message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.textContent = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html>
